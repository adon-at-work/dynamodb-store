'use strict';Object.defineProperty(exports,'__esModule',{value:true});var _extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key]}}}return target};var _expressSession=require('express-session');var _awsSdk=require('aws-sdk');var _awsSdk2=_interopRequireDefault(_awsSdk);var _constants=require('./constants');var _util=require('./util');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _asyncToGenerator(fn){return function(){var gen=fn.apply(this,arguments);return new Promise(function(resolve,reject){function step(key,arg){try{var info=gen[key](arg);var value=info.value}catch(error){reject(error);return}if(info.done){resolve(value)}else{return Promise.resolve(value).then(function(value){step('next',value)},function(err){step('throw',err)})}}return step('next')})}}class DynamoDBStore extends _expressSession.Store{constructor(options={},callback=_constants.DEFAULT_CALLBACK){var _this;_this=super();(0,_util.debug)('Initializing store',options);var _options$table=options.table;const table=_options$table===undefined?{}:_options$table;var _options$touchInterva=options.touchInterval;const touchInterval=_options$touchInterva===undefined?_constants.DEFAULT_TOUCH_INTERVAL:_options$touchInterva;var _options$ttl=options.ttl;const ttl=_options$ttl===undefined?_constants.DEFAULT_TTL:_options$ttl;var _options$keepExpired=options.keepExpired;const keepExpired=_options$keepExpired===undefined?_constants.DEFAULT_KEEP_EXPIRED_POLICY:_options$keepExpired;var _options$dynamoConfig=options.dynamoConfig;const dynamoConfig=_options$dynamoConfig===undefined?{}:_options$dynamoConfig;var _table$name=table.name;const name=_table$name===undefined?_constants.DEFAULT_TABLE_NAME:_table$name;var _table$hashPrefix=table.hashPrefix;const hashPrefix=_table$hashPrefix===undefined?_constants.DEFAULT_HASH_PREFIX:_table$hashPrefix;var _table$hashKey=table.hashKey;const hashKey=_table$hashKey===undefined?_constants.DEFAULT_HASH_KEY:_table$hashKey;var _table$readCapacityUn=table.readCapacityUnits;const readCapacityUnits=_table$readCapacityUn===undefined?_constants.DEFAULT_RCU:_table$readCapacityUn;var _table$writeCapacityU=table.writeCapacityUnits;const writeCapacityUnits=_table$writeCapacityU===undefined?_constants.DEFAULT_WCU:_table$writeCapacityU;this.tableName=name;this.hashPrefix=hashPrefix;this.hashKey=hashKey;this.readCapacityUnits=Number(readCapacityUnits);this.writeCapacityUnits=Number(writeCapacityUnits);this.touchInterval=touchInterval;this.ttl=ttl;this.keepExpired=keepExpired;this.dynamoService=new _awsSdk2.default.DynamoDB(_extends({},dynamoConfig,{apiVersion:_constants.API_VERSION}));this.documentClient=new _awsSdk2.default.DynamoDB.DocumentClient({service:this.dynamoService});_asyncToGenerator(function*(){try{yield _this.dynamoService.describeTable({TableName:_this.tableName}).promise();(0,_util.debug)(`Table ${_this.tableName} already exists.`,options);callback()}catch(err){_this.createTable(callback)}})()}createTable(callback){var _this2=this;return _asyncToGenerator(function*(){try{const params={TableName:_this2.tableName,KeySchema:[{AttributeName:_this2.hashKey,KeyType:'HASH'}],AttributeDefinitions:[{AttributeName:_this2.hashKey,AttributeType:'S'}],ProvisionedThroughput:{ReadCapacityUnits:_this2.readCapacityUnits,WriteCapacityUnits:_this2.writeCapacityUnits}};yield _this2.dynamoService.createTable(params).promise();(0,_util.debug)(`Table ${_this2.tableName} created`,params);callback()}catch(err){(0,_util.debug)(`Error creating table ${_this2.tableName}`,err);callback(err)}})()}set(sid,sess,callback){var _this3=this;return _asyncToGenerator(function*(){try{const sessionId=_this3.getSessionId(sid);const expires=_this3.getExpirationDate(sess);const params={TableName:_this3.tableName,Item:{[_this3.hashKey]:sessionId,expires:(0,_util.toSecondsEpoch)(expires),sess:_extends({},sess,{updated:Date.now()})}};(0,_util.debug)(`Saving session '${sid}'`,sess);_this3.documentClient.put(params,callback)}catch(err){(0,_util.debug)('Error saving session',{sid,sess,err});callback(err)}})()}get(sid,callback){var _this4=this;return _asyncToGenerator(function*(){try{const sessionId=_this4.getSessionId(sid);const params={TableName:_this4.tableName,Key:{[_this4.hashKey]:sessionId},ConsistentRead:true};const result=yield _this4.documentClient.get(params).promise();if(!result||!result.Item){(0,_util.debug)(`Session '${sid}' not found`);callback(null,null)}else if(!result.Item.expires||result.Item.expires<=(0,_util.toSecondsEpoch)(new Date)){(0,_util.debug)(`Found session '${sid}' but it is expired`);if(_this4.keepExpired){callback(null,null)}else{_this4.destroy(sid,callback)}}else{(0,_util.debug)(`Session '${sid}' found`,result.Item.sess);callback(null,result.Item.sess)}}catch(err){(0,_util.debug)(`Error getting session '${sid}'`,err);callback(err)}})()}destroy(sid,callback){var _this5=this;return _asyncToGenerator(function*(){try{const sessionId=_this5.getSessionId(sid);const params={TableName:_this5.tableName,Key:{[_this5.hashKey]:sessionId}};yield _this5.documentClient.delete(params).promise();(0,_util.debug)(`Destroyed session '${sid}'`);callback(null,null)}catch(err){(0,_util.debug)(`Error destroying session '${sid}'`,err);callback(err)}})()}touch(sid,sess,callback){var _this6=this;return _asyncToGenerator(function*(){try{if(!sess.updated||Number(sess.updated)+_this6.touchInterval<=Date.now()){const sessionId=_this6.getSessionId(sid);const expires=_this6.getExpirationDate(sess);const params={TableName:_this6.tableName,Key:{[_this6.hashKey]:sessionId},UpdateExpression:'set expires = :e, sess.#up = :n',ExpressionAttributeNames:{'#up':'updated'},ExpressionAttributeValues:{':e':(0,_util.toSecondsEpoch)(expires),':n':Date.now()},ReturnValues:'UPDATED_NEW'};(0,_util.debug)(`Touching session '${sid}'`);_this6.documentClient.update(params,callback)}else{(0,_util.debug)(`Skipping touch of session '${sid}'`);callback(null)}}catch(err){(0,_util.debug)(`Error touching session '${sid}'`,err);callback(err)}})()}getSessionId(sid){return`${this.hashPrefix}${sid}`}getExpirationDate(sess){let expirationDate=Date.now();if(sess.cookie&&Number.isInteger(sess.cookie.maxAge)){expirationDate+=sess.cookie.maxAge}else{expirationDate+=this.ttl}return new Date(expirationDate)}}exports.default=DynamoDBStore;